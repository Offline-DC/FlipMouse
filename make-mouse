#!/bin/bash
# make-mouse (macOS + Android NDK)
set -euo pipefail

# Parse args
DEBUG_MODE=0
for arg in "$@"; do
  case $arg in
    --debug) DEBUG_MODE=1 ;;
  esac
done

CWD="$(pwd)"

# Small helpers
nproc_compat() {
  if command -v nproc >/dev/null 2>&1; then nproc
  else sysctl -n hw.ncpu
  fi
}

require_cmd() {
  command -v "$1" >/dev/null 2>&1 || {
    echo "Missing required command: $1"
    exit 1
  }
}

if [ "$DEBUG_MODE" -eq 1 ]; then
  echo "=== Running in DEBUG mode for macOS (host build) ==="
  echo "Note: libevdev is Linux-specific; macOS debug build is not supported by this script."
  echo "Run without --debug to build the Android binary."
  exit 1
fi

# ---- Android build on macOS ----

# SDK/NDK locations (default Android Studio path on macOS)
ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-$HOME/Library/Android/sdk}"
NDK_VERSION="${NDK_VERSION:-26.1.10909125}"
NDK="$ANDROID_SDK_ROOT/ndk/$NDK_VERSION"

API="${API:-30}"
TARGET="${TARGET:-armv7a-linux-androideabi}"

# macOS host tag for Apple Silicon; fall back to x86_64 if needed
HOST_TAG=""
if [ -d "$NDK/toolchains/llvm/prebuilt/darwin-arm64" ]; then
  HOST_TAG="darwin-arm64"
elif [ -d "$NDK/toolchains/llvm/prebuilt/darwin-x86_64" ]; then
  HOST_TAG="darwin-x86_64"
else
  echo "Could not find NDK toolchain prebuilts under:"
  echo "  $NDK/toolchains/llvm/prebuilt"
  echo
  echo "Make sure NDK $NDK_VERSION is installed under:"
  echo "  $ANDROID_SDK_ROOT/ndk/$NDK_VERSION"
  exit 1
fi

TOOLCHAIN="$NDK/toolchains/llvm/prebuilt/$HOST_TAG"

# NDK wrapper compilers (recommended for Autoconf)
CC="$TOOLCHAIN/bin/${TARGET}${API}-clang"
CXX="$TOOLCHAIN/bin/${TARGET}${API}-clang++"
AR="$TOOLCHAIN/bin/llvm-ar"
RANLIB="$TOOLCHAIN/bin/llvm-ranlib"
STRIP="$TOOLCHAIN/bin/llvm-strip"

require_cmd curl
require_cmd tar
require_cmd make
require_cmd zip

# Sanity check the compiler exists
[ -x "$CC" ] || { echo "Missing compiler: $CC"; exit 1; }

BUILD_DIR="$CWD/build"
mkdir -p "$BUILD_DIR"

echo "=== Building for Android API $API ($TARGET) on macOS ($HOST_TAG) ==="
echo "SDK: $ANDROID_SDK_ROOT"
echo "NDK: $NDK"

# Download/extract libevdev
cd "$BUILD_DIR"
if [[ ! -f "install/include/libevdev-1.0/libevdev/libevdev.h" || \
      ! -f "install/include/libevdev-1.0/libevdev/libevdev-uinput.h" ]]; then

  if [ ! -f "libevdev-1.13.2.tar.xz" ]; then
    echo "Downloading libevdev..."
    curl -L -o libevdev-1.13.2.tar.xz \
      https://www.freedesktop.org/software/libevdev/libevdev-1.13.2.tar.xz
  fi

  if [ ! -d "libevdev-1.13.2" ]; then
    echo "Extracting libevdev..."
    tar xf libevdev-1.13.2.tar.xz
  fi

  cd "$BUILD_DIR/libevdev-1.13.2"

  # Clean prior configure cache if you rerun with different toolchain/flags
  rm -f config.cache

  echo "Configuring libevdev..."
  # Important: use wrapper CC/CXX (not `clang --target=...`) and pass host
  CC="$CC" \
  CXX="$CXX" \
  AR="$AR" \
  RANLIB="$RANLIB" \
  STRIP="$STRIP" \
  ./configure \
    --host="$TARGET" \
    --prefix="$BUILD_DIR/install" \
    --disable-shared \
    --enable-static

  echo "Building libevdev..."
  make -j"$(nproc_compat)"
  make install
fi

echo "Building mouse application..."
cd "$CWD"

"$CC" \
  -I"$BUILD_DIR/install/include" \
  -I"$BUILD_DIR/install/include/libevdev-1.0" \
  -L"$BUILD_DIR/install/lib" \
  -o "$BUILD_DIR/mouse" \
  *.c \
  -levdev

# Strip binary
"$STRIP" "$BUILD_DIR/mouse"

echo "=== Build completed ==="
echo "Binary is at: $BUILD_DIR/mouse"

# Bundle zip
rm -rf "$CWD/build/bundle"
mkdir -p "$CWD/build/bundle"
cd "$CWD/build/bundle"
cp -r "$CWD/properties/"* .
cp "$CWD/build/mouse" .
zip -r -FS FlipMouse.zip .
echo "Bundle is at: $CWD/build/bundle/FlipMouse.zip"
